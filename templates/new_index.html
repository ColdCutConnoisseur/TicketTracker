
{% extends "bootstrap/base.html" %}

{% block title %}Ticket Inventory{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block styles %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/index.css') }}">
{% endblock %}

{% block content %}

<!-- Nav tabs -->
<ul class="nav nav-tabs" id="inventory-tabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="closed-inventory-tab" data-bs-toggle="tab" data-bs-target="#closed-inventory" type="button" role="tab" aria-controls="closed-inventory" aria-selected="true">Closed Inventory</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="open-inventory-tab" data-bs-toggle="tab" data-bs-target="#open-inventory" type="button" role="tab" aria-controls="open-inventory" aria-selected="false">Open Inventory</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="watchlist-tab" data-bs-toggle="tab" data-bs-target="#watchlist" type="button" role="tab" aria-controls="watchlist" aria-selected="false">Watchlist</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="editor-tab" data-bs-toggle="tab" data-bs-target="#editor" type="button" role="tab" aria-controls="editor" aria-selected="false">Editor</button>
  </li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
  <div class="tab-pane active" id="closed-inventory" role="tabpanel" aria-labelledby="closed-inventory-tab">

    <div class="container-fluid" id="closed-inventory-table-container">
      <!--<h2 id="closed-inventory-label">Closed Inventory</h2>-->
      <table class="table">
        <thead>
          <tr>
            {% for header in closed_headers %}
              <th scope="col">{{ header }}</th>
            {% endfor %}
          </tr>
        </thead>
    
        <tbody>
          {% for c_inv in closed_inventory %}
          {% set profit = c_inv.sale_total_proceeds - c_inv.total_cost %}
            <tr>
              <th role="row">{{ c_inv.event_name | formatEventName }}</th>
              <td>{{ '${0:0.2f}'.format(c_inv.total_cost) }}</td>
              <td>{{ '${0:0.2f}'.format(c_inv.sale_total_proceeds) }}</td>
              {% if profit > 0 %}
                <td style="color: green;">{{ '${0:0.2f}'.format(profit) }}</td>
              {% else %}
                <td style="color: red;">{{ '-${0:0.2f}'.format(profit | abs) }}</td>
              {% endif %}

              {% if c_inv.sale_payout_date is none %}
              <td>Not Sold</td>
              {% else %}
              <td>{{ c_inv.sale_payout_date.strftime('%Y-%m-%d') }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>


  <div class="tab-pane" id="open-inventory" role="tabpanel" aria-labelledby="open-inventory-tab">

    <div class="container-fluid" id="open-inventory-table-container">
      <!--<h2 id="open-inventory-label">Open Inventory</h2>-->
      <table class="table">
        <thead>
          <tr>
            {% for header in open_headers %}
              <th scope="col">{{ header }}</th>
            {% endfor %}
          </tr>
        </thead>



        <!--REFERENCE ONLY ["Event Name", "Venue", "Event Date", "Qty Purchased", "Total Cost", "Cost Per", "Section", "Row", "Seat", "Notes", "Manual Price Track", "Check Price URL"]-->

    
        <tbody>
          {% for c_inv in open_inventory %}
            <tr>
              <th role="row">{{ c_inv.event_name }}</th>
              <td>{{ c_inv.venue }}</td>
              <td>{{ c_inv.event_date.strftime('%Y-%m-%d') }}</td>
              <td>{{ '{0:0.2f}'.format(c_inv.qty_purchased) }}</td>
              <td>{{ '${0:0.2f}'.format(c_inv.total_cost) }}</td>
              <td>{{ '${0:0.2f}'.format(c_inv.cost_per) }}</td>
              <td>{{ c_inv.section }}</td>
              <td>{{ c_inv.row }}</td>
              <td>{{ c_inv.seat }}</td>
              <td>{{ c_inv.notes }}</td>
              <!--<td>{{ c_inv.manual_price_track }}</td>
              <td>{{ c_inv.check_price_url }}</td>-->
              <td>
                <button class="btn btn-primary" onclick="showPriceChart({{ c_inv.event_id }}, this);">Show Price Chart</button>
                <div style="height: 400px; width: 600px; display: none;" id="priceChartParent-{{ c_inv.event_id }}">
                  <canvas id="priceChart-{{ c_inv.event_id }}"></canvas>
                </div>
              </td>
              <td>
                <div style="height: 400px; width: 600px;">
                  <canvas id="supplyChart-{{ c_inv.event_id }}"></canvas>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>


  <div class="tab-pane" id="watchlist" role="tabpanel" aria-labelledby="watchlist-tab">

  </div>


  <div class="tab-pane" id="editor" role="tabpanel" aria-labelledby="editor-tab">
    <h3>Coming soon...(maybe)</h3>

  </div>

</div>


<!--
<nav>
  <div class="nav nav-tabs" id="inventory-nav-tab" role="tablist">
    <button class="nav-link active" id="nav-closed-inventry-tab" data-bs-toggle="tab" data-bs-target="#nav-closed-inventory" type="button" role="tab" aria-controls="nav-closed-inventory" aria-selected="true">
      Closed Inventory
      <a href="#nav-closed-inventory"></a>
    </button>
    <button class="nav-link" id="nav-open-inventory-tab" data-bs-toggle="tab" data-bs-target="#nav-open-inventory" type="button" role="tab" aria-controls="nav-open-inventory" aria-selected="false">Open Inventory</button>
    <button class="nav-link" id="nav-watchlist-tab" data-bs-toggle="tab" data-bs-target="#nav-watchlist" type="button" role="tab" aria-controls="nav-watchlist" aria-selected="false">Watchlist</button>
  </div>
</nav>

<div class="tab-content" id="nav-tabContent">
  <div class="tab-pane fade show active" id="nav-closed-inventory" role="tabpanel" aria-labelledby="nav-closed-inventory-tab">
    
    <h3>Yooooo</h3>

    
    

  </div>

  <div class="tab-pane fade" id="nav-open-inventory" role="tabpanel" aria-labelledby="nav-open-inventory-tab">
    <h3>Changed. Yep.</h3>
  </div>

  <div class="tab-pane fade" id="nav-watchlist" role="tabpanel" aria-labelledby="nav-watchlist-tab">
    <h3>Again. yep.</h3>

  </div>

</div>

-->

{% endblock %}



{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script type="text/javascript" src="{{ url_for('static', filename='scripts/tabbable.js') }}"></script>

<script>
    console.log("Running html script...");
    // Group data first
    
    const openEventIds = {{ open_event_ids | tojson }};
    const openEventDps = {{ open_event_dps | tojson }};

    console.log("Here are the open event datapoints: " + openEventDps);
    console.log("Here are the open event IDs: " + openEventIds);

    const openEventGroups = {};

    for (var i = 0; i < openEventIds.length; i++) {
        const currentID = openEventIds[i];
        const eventPrices = [];
        const eventDates = [];
        const eventSupply = [];

        Object.values(openEventDps).forEach((datapoint) => {
            var currentObsId = datapoint[0];
            var currentPrice = datapoint[1];
            var currentTime = datapoint[2];
            var currentSupply = datapoint[3];

            if (currentObsId == currentID) {
                eventPrices.push(currentPrice);
                eventDates.push(currentTime);
                eventSupply.push(currentSupply);
            }
                
        });

        openEventGroups[currentID] = [eventPrices, eventDates, eventSupply];    
    }

    // Create chart for each event
    for (var i = 0; i < openEventIds.length; i++) {
        const currentID = openEventIds[i];
        const currentEventDps = openEventGroups[currentID];

        const chartID = 'priceChart-' + currentID;
        const supplyChartID = 'supplyChart-' + currentID;
        
        const eventPrices = currentEventDps[0];
        const eventLabels = currentEventDps[1];
        const eventSupply = currentEventDps[2];

        const data = {
            labels: eventLabels,
            datasets: [{
                label: 'Price',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: eventPrices,
            }]
        };

        const supplyData = {
            labels: eventLabels,
            datasets: [{
                label: 'Section Supply',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: eventSupply,
            }]
        };

        const config = {
            type: 'line',
            data: data,
            options: { 
              maintainAspectRatio: false,
              scales: {
                x: {
                  //type: 'time',
                  //time: {
                  //  unit: 'day',
                  //  unitStepSize: 1,
                  //  displayFormats: {
                  //    day: 'MMM D'
                  //  }
                  //}
                },
                y: {
                  beginAtZero: true
                }
              }
            }
            };

          const supplyConfig = {
            type: 'line',
            data: supplyData,
            options: { 
              maintainAspectRatio: false,
              scales: {
                x: {
                  //type: 'time',
                  //time: {
                  //  unit: 'day',
                  //  unitStepSize: 1,
                  //  displayFormats: {
                  //    day: 'MMM D'
                  //  }
                  //}
                },
                y: {
                  beginAtZero: true
                }
              }
            }
            };

        const newChart = new Chart(
            document.getElementById(chartID),
            config
        );

        const newSupplyChart = new Chart(
            document.getElementById(supplyChartID),
            supplyConfig
        );
    }
</script>

<script>
  function showPriceChart(index, buttonElement) {
    const chartId = "priceChartParent-" + index;
    const chartParentElement = document.getElementById(chartId);

    // If hidden, show & change button text
    if (chartParentElement.style.display == 'none') {
        chartParentElement.style.display = 'block';
        buttonElement.innerText = "Hide Price Chart";
    }
    else {
        chartParentElement.style.display = 'none';
        buttonElement.innerText = "Show Price Chart";
    }
  }
</script>

<!--
<script>
  $(document).ready(function()
  {
    $("table tr:odd").css({
      "background-color": "#eda982",
      "color": "green"});
  });
</script>
-->

{% endblock %}

